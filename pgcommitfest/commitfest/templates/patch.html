{%extends "base.html"%}
{%load commitfest%}
{%block contents%}
 {%include "patch_administrative.inc"%}
 {%include "patch_workflow.inc"%}

 <div class="workflow">
  <table class="table table-bordered">
   <tbody>
    {%include "patch_tr_email.inc"%}
    {%include "patch_tr_cfbot.inc"%}
    <tr>
     <th>Links</th>
     <td>
      {%if patch.wikilink%}
       <a href="{{patch.wikilink}}">Wiki</a>
      {%endif%}
      {%if patch.gitlink%}
       <a href="{{patch.gitlink}}">Git</a>
      {%endif%}
      <a class="btn btn-default pull-right" href="edit/">Edit</a>
     </td>
    </tr>
    <tr>
     <th>Status</th>
     <td>{%for c in patch_commitfests %}
      <div style="margin-bottom: 3px;">
       <a href="/{{c.commitfest.id}}/">{{c.commitfest}}</a>:
       <span class="label label-{{c.status|patchstatuslabel}}">{{c.statusstring}}</span>
       <span>({{c.enterdate}} to {%if c.leavedate%}{{c.leavedate}}{%else%}present{%endif%})</span>
      </div>
     {%endfor%}
     </td>
    </tr>
   </tbody>
  </table>
 </div>

 <div>
  <button class="btn btn-default" data-toggle="collapse" data-target="#history-table">Toggle History Table</button>
  <button class="btn btn-default" data-toggle="collapse" data-target="#keyvalue-table">Toggle Key-Value Table</button>
 </div>

 <div id="history-table" class="table table-bordered">
  <h3>History</h3>
  <table class="table table-bordered table-striped table-condensed">
   <thead>
    <tr>
     <th>When</th>
     <th>Who</th>
     <th>What</th>
    </tr>
   </thead>
   <tbody>
    {%for h in patch.history %}
     <tr>
      <td style="white-space: nowrap;">{{h.date}}</td>
      <td style="white-space: nowrap;">{{h.by_string}}</td>
      <td width="99%">{{h.what}}</td>
     </tr>
    {%endfor%}
   </tbody>
  </table>
 </div>

{%include "patch_table_keyvalue.inc"%}

{%comment%}commit dialog{%endcomment%}
 <div class="modal fade" id="commitModal" role="dialog">
  <div class="modal-dialog modal-lg">
   <div class="modal-content">
    <div class="modal-header">
     <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
     <h3>Flag as committed</h3>
    </div>
    <div class="modal-body">
     <form class="form" style="margin-bottom: 5px;">
      <div class="form-group">
       <label for="committerlist">Committer</label>
       <select id="committerSelect" class="form-control">
        <option value="" style="display:none;"></option>
        {%for c in committers%}
         <option value="{{c.user.username}}">{{c.user.first_name}} {{c.user.last_name}}</option>
        {%endfor%}
       </select>
      </div>
     </form>
    </div>
    <div class="modal-footer">
     <a href="#" class="btn btn-default" data-dismiss="modal">Close</a>
     <a href="#" class="btn btn-default btn-primary" id="doCommitButton">Flag as committed</a>
    </div>
   </div>
  </div>
 </div>

 {%include "thread_attach.inc"%}
{%comment%}Modal dialog for adding annotation{%endcomment%}
 <div class="modal fade" id="annotateModal" role="dialog">
  <div class="modal-dialog modal-lg"><div class="modal-content">
   <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Add annotation</h3>
   </div>
   <div id="annotateMessageBody" class="modal-body">
    <div>Pick one of the messages in this thread</div>
    <div id="annotateListWrap">
     <select id="annotateMessageList" style="width:100%;" onChange="annotateMsgPicked()">
     </select>
    </div>
    <div>Or copy/paste the message-id:</div>
    <div id="annotateMsgidWrap">
     <input id="annotateMsgId" type="text" style="width:100%" onKeyUp="annotateChanged()">
    </div>
    <div><br/></div>
    <div>Enter a message for the annotation</div>
    <div id="annotateTextWrap">
     <input id="annotateMessage" type="text" style="width:100%" onKeyUp="annotateChanged()">
    </div>
   </div>
   <div class="modal-footer">
    <a href="#" class="btn btn-default" data-dismiss="modal">Close</a>
    <a href="#" id="doAnnotateMessageButton" class="btn btn-default btn-primary disabled">Add annotation</a>
   </div>
  </div></div>
 </div>
{%endblock%}

{%block morescript%}
 <script>
  $(document).ready(function() {
   $('button.close-nofloat').each(function(i,o) {
    $(o).tooltip();
   });
  });
  {%if attachnow%}
   $(document).ready(function() {
    attachThread({{cf.id}},{{patch.id}}, function() {
     document.location.replace('/{{cf.id}}/{{patch.id}}/');
    });
   });
  {%endif%}
 </script>
{%endblock%}
