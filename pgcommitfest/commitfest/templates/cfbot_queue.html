{% extends "base.html" %}
{% block contents %}
<div id="response-message" style="margin-bottom: 20px; color: green;"> </div> <!-- Response message -->

<div>
    <strong>Selected Branch ID:</strong> <span id="selected-branch-id">None</span>
</div>
<div>
    <button id="process-build-tasks-btn" disabled>Process Build Tasks</button>
</div>

<div>CI Branches</div>
<table border="1" id="ci-branches-table" style="width: 100%; margin-bottom: 20px;">
    <thead>
        <tr>
            <th>Patch ID</th>
            <th>Branch ID</th>
            <th>Branch Name</th>
            <th>Commit ID</th>
            <th>Apply URL</th>
            <th>Status</th>
            <th>Needs Rebase Since</th>
            <th>Failing Since</th>
            <th>Created</th>
            <th>Modified</th>
            <th>Task Count</th> <!-- New column -->
        </tr>
    </thead>
    <tbody>
        <!-- Table rows will be dynamically populated via AJAX -->
    </tbody>
</table>

<div>CFBot Tasks</div>
<table border="1" id="cfbot-tasks-table" style="width: 100%; margin-bottom: 20px;">
    <thead>
        <tr>
            <th>Task ID</th>
            <th>Task Name</th>
            <th>Patch ID</th>
            <th>Branch ID</th>
            <th>Position</th>
            <th>Status</th>
            <th>Created</th>
            <th>Modified</th>
        </tr>
    </thead>
    <tbody>
        <!-- Table rows will be dynamically populated via AJAX -->
    </tbody>
</table>

<div>
    <strong>Selected Task ID:</strong> <span id="selected-task-id">None</span>
</div>

<div>
    <button class="task-status-btn" data-status="CREATED">Set to Created</button>
    <button class="task-status-btn" data-status="NEEDS_APPROVAL">Set to Needs Approval</button>
    <button class="task-status-btn" data-status="TRIGGERED">Set to Triggered</button>
    <button class="task-status-btn" data-status="EXECUTING">Set to Executing</button>
    <button class="task-status-btn" data-status="FAILED">Set to Failed</button>
    <button class="task-status-btn" data-status="COMPLETED">Set to Completed</button>
    <button class="task-status-btn" data-status="SCHEDULED">Set to Scheduled</button>
    <button class="task-status-btn" data-status="ABORTED">Set to Aborted</button>
    <button class="task-status-btn" data-status="ERRORED">Set to Errored</button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let selectedBranchId = null;

        // Fetch and populate the CI Branches table
        fetch("/api/v1/cfbot/branches")
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const tableBody = document.getElementById("ci-branches-table").getElementsByTagName("tbody")[0];
                tableBody.innerHTML = ""; // Clear existing rows

                data.branches.forEach(branch => {
                    const row = document.createElement("tr");
                    row.setAttribute("data-branch-id", branch.branch_id);
                    row.innerHTML = `
                        <td>${branch.patch_id}</td>
                        <td>${branch.branch_id}</td>
                        <td>${branch.branch_name}</td>
                        <td>${branch.commit_id || ""}</td>
                        <td><a href="${branch.apply_url}" target="_blank">${branch.apply_url}</a></td>
                        <td>${branch.status}</td>
                        <td>${branch.needs_rebase_since || ""}</td>
                        <td>${branch.failing_since || ""}</td>
                        <td>${branch.created}</td>
                        <td>${branch.modified}</td>
                        <td>${branch.task_count || 0}</td> <!-- Display task count -->
                    `;
                    row.addEventListener("click", function () {
                        highlightRow(this);
                        fetchTasksForBranch(branch.branch_id);
                    });
                    tableBody.appendChild(row);
                });
            })
            .catch(error => console.error("Error:", error));

        function fetchTasksForBranch(branchId) {
            // Fetch tasks for the selected branch
            fetch(`/api/v1/cfbot/tasks?branch_id=${branchId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    const tableBody = document.getElementById("cfbot-tasks-table").getElementsByTagName("tbody")[0];
                    tableBody.innerHTML = ""; // Clear existing rows

                    data.tasks.forEach(task => {
                        const row = document.createElement("tr");
                        row.setAttribute("data-task-id", task.task_id);
                        row.innerHTML = `
                            <td>${task.task_id}</td>
                            <td>${task.task_name}</td>
                            <td>${task.patch_id}</td>
                            <td>${task.branch_id}</td>
                            <td>${task.position}</td>
                            <td>${task.status}</td>
                            <td>${task.created}</td>
                            <td>${task.modified}</td>
                        `;
                        row.addEventListener("click", function () {
                            highlightTaskRow(this);
                            updateSelectedTaskId(task.task_id);
                        });
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error("Error:", error));
        }

        function highlightTaskRow(row) {
            // Highlight the selected task row and remove highlight from others
            const rows = document.querySelectorAll("#cfbot-tasks-table tbody tr");
            rows.forEach(r => r.classList.remove("selected-task-row"));
            row.classList.add("selected-task-row");
        }

        function updateSelectedTaskId(taskId) {
            // Update the label with the selected task ID
            document.getElementById("selected-task-id").textContent = taskId || "None";
        }

        document.querySelectorAll(".task-status-btn").forEach(button => {
            button.addEventListener("click", function () {
                const selectedTaskId = document.getElementById("selected-task-id").textContent;
                if (selectedTaskId === "None") {
                    alert("Please select a task first.");
                    return;
                }

                const newStatus = this.getAttribute("data-status");
                updateTaskStatus(selectedTaskId, newStatus);
            });
        });

        function updateTaskStatus(taskId, status) {
            fetch(`/api/v1/cfbot/task/${taskId}/update_status?status=${status}`, {
                method: "GET",
            })
                .then(response => response.json())
                .then(data => {
                    const responseMessage = document.getElementById("response-message");
                    if (data.message) {
                        responseMessage.textContent = data.message;
                        responseMessage.style.color = "green";
                    } else if (data.error) {
                        responseMessage.textContent = data.error;
                        responseMessage.style.color = "red";
                    }

                    // Optionally, refresh the tasks table
                    const branchId = document.querySelector(".selected-row")?.getAttribute("data-branch-id");
                    if (branchId) {
                        fetchTasksForBranch(branchId);
                    }
                })
                .catch(error => {
                    const responseMessage = document.getElementById("response-message");
                    responseMessage.textContent = "An error occurred while updating the task status.";
                    responseMessage.style.color = "red";
                    console.error("Error:", error);
                });
        }

        document.getElementById("process-build-tasks-btn").addEventListener("click", function () {
            const selectedBranchId = document.getElementById("selected-branch-id").textContent;
            if (selectedBranchId === "None") {
                alert("Please select a branch first.");
                return;
            }

            fetch(`/api/v1/cfbot/branches/${selectedBranchId}/process_build_tasks`, {
                method: "GET",
            })
                .then(response => response.json())
                .then(data => {
                    const responseMessage = document.getElementById("response-message");
                    if (data.message) {
                        responseMessage.textContent = data.message;
                        responseMessage.style.color = "green";
                    } else if (data.error) {
                        responseMessage.textContent = data.error;
                        responseMessage.style.color = "red";
                    }
                })
                .catch(error => {
                    const responseMessage = document.getElementById("response-message");
                    responseMessage.textContent = "An error occurred while processing build tasks.";
                    responseMessage.style.color = "red";
                    console.error("Error:", error);
                });
        });
    });

    function highlightRow(row) {
        // Highlight the selected row and remove highlight from others
        const rows = document.querySelectorAll("#ci-branches-table tbody tr");
        rows.forEach(r => r.classList.remove("selected-row"));
        row.classList.add("selected-row");

        // Update the selected branch ID in the label
        const branchId = row.getAttribute("data-branch-id");
        document.getElementById("selected-branch-id").textContent = branchId || "None";
        document.getElementById("process-build-tasks-btn").disabled = false;
    }
</script>

<style>
    .selected-row {
        background-color: #d3d3d3;
    }

    .selected-task-row {
        background-color: #add8e6;
    }
</style>

<div>
    <button id="add-data-btn">Add Made-Up Data</button>
</div>

<div>Queue table - ringed</div>
<h2>{{ queue.name }} ( {{ queue.current_queue_item }} )</h2>

<div>
    <button id="get-and-move-btn">Get and Move</button>
    <button id="peek-btn">Peek</button>
</div>

<div id="queue" style="display: flex; gap: 20px;">
    <div style="flex: 70%;">
        <table border="1" id="queue-table" style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Current</th>
                    <th>Patch ID</th>
                    <th>Message ID</th>
                    <th>Processed Date</th>
                    <th>Ignore Date</th>
                    <th>ll_prev</th>
                    <th>ll_next</th>
                    <th>Attachments</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table rows will be dynamically populated via AJAX -->
            </tbody>
        </table>
    </div>
    <div id="json-display" style="flex: 30%; border: 1px solid #ccc; padding: 10px;">
        <h3>Details</h3>
        <div id="json-keys">
            <strong>ID:</strong> <span id="json-id"></span><br>
            <strong>Patch ID:</strong> <span id="json-patch-id"></span><br>
            <strong>Message ID:</strong> <span id="json-message-id"></span><br>
            <strong>Processed Date:</strong> <span id="json-processed-date"></span><br>
            <strong>Ignore Date:</strong> <span id="json-ignore-date"></span><br>
            <strong>ll_prev:</strong> <span id="json-ll-prev"></span><br>
            <strong>ll_next:</strong> <span id="json-ll-next"></span><br>
            <strong>Attachments:</strong>
            <ul id="json-attachments">
                <!-- Attachment list will be dynamically populated -->
            </ul>
        </div>
    </div>
</div>

<script>
    // Populate the queue table and perform a peek on page load
    document.addEventListener("DOMContentLoaded", function () {
        // Fetch the queue table
        fetch("/api/v1/cfbot/get_queue")
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const tableBody = document.getElementById("queue-table").getElementsByTagName("tbody")[0];
                tableBody.innerHTML = ""; // Clear existing rows

                data.queuetable.forEach(item => {
                    const row = document.createElement("tr");
                    row.setAttribute("data-id", item.id);
                    row.innerHTML = generateRowHTML(item);
                    if (item.is_current) {
                        row.classList.add("current-row");
                    }
                    tableBody.appendChild(row);
                });
            })
            .catch(error => console.error("Error:", error));

        // Perform a peek to populate the JSON display
        performPeek();
    });

    document.getElementById("get-and-move-btn").addEventListener("click", function () {
        fetch("/api/v1/cfbot/get_and_move")
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Update the JSON display with the returned data
                const returned = data.returned;
                updateJsonDisplay(returned);

                // Replace the row of the returned item in the table
                const returnedRow = document.querySelector(`[data-id='${returned.id}']`);
                if (returnedRow) {
                    returnedRow.innerHTML = generateRowHTML(returned);
                    returnedRow.classList.remove("current-row");
                }

                // Update the table with the newcurrent data
                const newcurrent = data.newcurrent;
                const currentId = document.querySelector(".current-row")?.getAttribute("data-id");
                if (currentId) {
                    remove_current(currentId);
                }
                add_current(newcurrent.id);
            })
            .catch(error => console.error("Error:", error));
    });

    document.getElementById("peek-btn").addEventListener("click", function () {
        performPeek();
    });

    document.getElementById("add-data-btn").addEventListener("click", function () {
        fetch("/api/v1/cfbot/get_and_move")
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const patchId = data.returned.patch_id;
                branchId = patchId
                // Prepare made-up data for the cfbot_notify endpoint
                const payload = {
                    shared_secret: "INSECURE", // Replace with the actual shared secret
                    branch_status: {
                        submission_id: patchId,
                        branch_id: branchId,
                        branch_name: `branch_${patchId}`,
                        commit_id: `commit_${Math.random().toString(36).substring(2, 8)}`,
                        apply_url: `http://example.com/apply/${patchId}`,
                        status: "testing",
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        version: "v0",
                        patch_count: Math.floor(Math.random() * 10),
                        first_additions: Math.floor(Math.random() * 100),
                        first_deletions: Math.floor(Math.random() * 50),
                        all_additions: Math.floor(Math.random() * 200),
                        all_deletions: Math.floor(Math.random() * 100),
                    },
                    task_status: {
                        task_id: `task_${Math.random().toString(36).substring(2, 8)}`,
                        task_name: `Task for patch ${patchId}`,
                        patch_id: patchId,
                        branch_id: branchId,
                        position: 1,
                        status: "CREATED",
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                    },
                };

                // Send the payload to the cfbot_notify endpoint
                fetch("/cfbot_notify/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                })
                    .then(response => {
                        if (response.ok) {
                            console.log("Made-up data sent to cfbot_notify.");
                        } else {
                            console.error("Failed to send data to cfbot_notify.");
                        }
                    })
                    .catch(error => console.error("Error:", error));
            })
            .catch(error => console.error("Error:", error));
    });

    function performPeek() {
        fetch("/api/v1/cfbot/peek")
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Update the JSON display with the peeked data
                updateJsonDisplay(data);
            })
            .catch(error => console.error("Error:", error));
    }

    function generateRowHTML(item) {
        return `
            <td>${item.id}</td>
            <td>${item.is_current ? "✔" : ""}</td>
            <td>${item.patch_id}</td>
            <td>${item.message_id}</td>
            <td>${item.processed_date || ""}</td>
            <td>${item.ignore_date || ""}</td>
            <td>${item.ll_prev || ""}</td>
            <td>${item.ll_next || ""}</td>
            <td>${item.attachments ? item.attachments.length : 0}</td>
        `;
    }

    function updateJsonDisplay(data) {
        document.getElementById("json-id").textContent = data.id || "";
        document.getElementById("json-patch-id").textContent = data.patch_id || "";
        document.getElementById("json-message-id").textContent = data.message_id || "";
        document.getElementById("json-processed-date").textContent = data.processed_date || "";
        document.getElementById("json-ignore-date").textContent = data.ignore_date || "";
        document.getElementById("json-ll-prev").textContent = data.ll_prev || "";
        document.getElementById("json-ll-next").textContent = data.ll_next || "";

        const attachmentsList = document.getElementById("json-attachments");
        attachmentsList.innerHTML = ""; // Clear existing list
        if (data.attachments && data.attachments.length > 0) {
            data.attachments.forEach(attachment => {
                const listItem = document.createElement("li");
                listItem.textContent = `${attachment.filename} (ID: ${attachment.attachment_id})`;
                attachmentsList.appendChild(listItem);
            });
        }
    }

    function add_current(id) {
        const row = document.querySelector(`[data-id='${id}']`);
        if (row) {
            row.classList.add("current-row");
            row.children[1].textContent = "✔";
        }
    }

    function remove_current(id) {
        const row = document.querySelector(`[data-id='${id}']`);
        if (row) {
            row.classList.remove("current-row");
            row.children[1].textContent = "";
        }
    }
</script>

{% endblock %}
